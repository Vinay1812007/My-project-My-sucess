<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Indie Drift Racer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="menu">
  <h1>üèé Indie Drift Racer</h1>
  <input id="username" placeholder="Username">
  <button onclick="login()">Play</button>
  <button onclick="quickMatch()">Quick Match</button>
</div>

<canvas id="game" width="360" height="640"></canvas>

<div id="hud">
  <span id="speed">0</span>
  <span id="league"></span>
</div>

<div id="chat">
  <div id="messages"></div>
  <input id="msg">
  <button onclick="sendMsg()">Send</button>
</div>

<script>
/* ================== BASIC SETUP ================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let keys = {}, USER = null;
let room = null, spectate = false;

/* ================== LOGIN ================== */
function login(){
  USER = username.value || "Guest";
  fetch("/api/login?user="+USER,{method:"POST"});
  menu.style.display="none";
}

/* ================== MATCHMAKING ================== */
function quickMatch(){
  fetch("/api/match").then(r=>r.json()).then(d=>{
    room = d.room;
    start();
  });
}

/* ================== MULTIPLAYER ================== */
let ws, players = {};
function start(){
  canvas.style.display="block";
  ws = new WebSocket(`wss://${location.host}/ws/${room}`);
  ws.onmessage = e => players = JSON.parse(e.data);
  requestAnimationFrame(loop);
}

/* ================== CAR ================== */
let car = {
  x:180,y:520,speed:0,angle:0,damage:0,skin:"#f00",
  update(){
    if(keys.ArrowUp) this.speed+=0.2;
    if(keys.ArrowDown) this.speed-=0.3;
    if(keys.ArrowLeft) this.angle-=this.speed*0.002;
    if(keys.ArrowRight) this.angle+=this.speed*0.002;
    this.speed*=0.98;
    this.x+=Math.sin(this.angle)*this.speed;
    this.y-=Math.cos(this.angle)*this.speed;
    this.damage=Math.min(100,this.damage+Math.random()*0.05);
  },
  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.angle);
    ctx.fillStyle=this.skin;
    ctx.fillRect(-10,-20,20,40);
    if(this.damage>60){
      ctx.strokeStyle="orange";
      ctx.strokeRect(-10,-20,20,40);
    }
    ctx.restore();
  }
};

/* ================== AI TRAFFIC ================== */
let ai=[];
for(let i=0;i<4;i++){
  ai.push({x:Math.random()*360,y:-i*200,speed:2});
}

/* ================== LOOP ================== */
function loop(){
  ctx.clearRect(0,0,360,640);

  car.update();
  car.draw();

  ai.forEach(a=>{
    a.y+=a.speed;
    ctx.fillStyle="#666";
    ctx.fillRect(a.x-10,a.y-20,20,40);
  });

  speed.innerText = Math.abs(car.speed|0)+" km/h";

  if(ws) ws.send(JSON.stringify({x:car.x,y:car.y,speed:car.speed}));

  Object.values(players).forEach(p=>{
    ctx.fillStyle="#00f";
    ctx.fillRect(p.x-10,p.y-20,20,40);
  });

  requestAnimationFrame(loop);
}

/* ================== INPUT ================== */
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;

/* ================== CONTROLLER ================== */
setInterval(()=>{
  const g=navigator.getGamepads()[0];
  if(!g) return;
  if(g.buttons[0].pressed) keys.ArrowUp=true;
  if(g.buttons[1].pressed) keys.ArrowDown=true;
  if(g.axes[0]<-0.3) keys.ArrowLeft=true;
  if(g.axes[0]>0.3) keys.ArrowRight=true;
},100);

/* ================== CHAT ================== */
let chatWS;
function connectChat(){
  chatWS=new WebSocket(`wss://${location.host}/ws/chat/${room}`);
  chatWS.onmessage=e=>{
    messages.innerHTML+=`<div>${e.data}</div>`;
    messages.scrollTop=messages.scrollHeight;
  };
}
function sendMsg(){
  chatWS.send(USER+": "+msg.value);
  msg.value="";
}
</script>
</body>
</html>
