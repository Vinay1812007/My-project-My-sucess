<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chatgram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/style.css" />
</head>

<body>

<!-- ================= HEADER ================= -->
<div class="header">Chatgram</div>

<!-- ================= CHAT LIST ================= -->
<div id="chatArea" class="safe-bottom" style="padding:16px;">

  <!-- Search -->
  <input id="search" placeholder="Search messages‚Ä¶" oninput="searchMessages()" />

  <!-- Messages -->
  <div id="messages"></div>

  <!-- Typing indicator -->
  <div id="typing" style="font-size:13px;color:var(--text-muted);display:none;">
    typing‚Ä¶
  </div>

</div>

<!-- ================= INPUT BAR ================= -->
<div class="glass" style="
  position:fixed;
  bottom:70px;
  width:100%;
  padding:12px;
  display:flex;
  gap:10px;
">
  <input id="msg" placeholder="iMessage‚Ä¶" oninput="sendTyping()" />
  <button class="button" onclick="send()">‚û§</button>
</div>

<!-- ================= TAB BAR ================= -->
<div class="tab-bar">
  <div class="tab-item" onclick="go('index.html')">Home</div>
  <div class="tab-item active">Chat</div>
  <div class="tab-item" onclick="go('music.html')">Music</div>
  <div class="tab-item" onclick="go('ai.html')">AI</div>
</div>

<!-- ================= IMAGE / VIDEO ================= -->
<input type="file" id="mediaInput" accept="image/*,video/*" hidden onchange="sendMedia()" />

<!-- ================= SCRIPT ================= -->
<script>
/* ===============================
   CHATGRAM CORE LOGIC
   =============================== */

const email = localStorage.email || prompt("Enter your email");
localStorage.email = email;

const ws = new WebSocket(
  `wss://${location.host}/?email=${encodeURIComponent(email)}`
);

const messagesEl = document.getElementById("messages");
const typingEl = document.getElementById("typing");
let messages = JSON.parse(localStorage.messages || "[]");

/* ---------- Load Stored Messages ---------- */
messages.forEach(render);

/* ---------- WebSocket ---------- */
ws.onmessage = e => {
  const data = JSON.parse(e.data);

  if (data.type === "typing") {
    typingEl.style.display = "block";
    setTimeout(() => typingEl.style.display = "none", 1200);
  }

  if (data.type === "msg") {
    messages.push(data);
    save();
    render(data);
    sendRead(data.id);
  }

  if (data.type === "reaction") {
    const msg = messages.find(m => m.id === data.id);
    if (msg) {
      msg.reactions = msg.reactions || {};
      msg.reactions[data.emoji] = true;
      save();
      redraw();
    }
  }
};

/* ---------- Send Message ---------- */
function send() {
  const text = msg.value.trim();
  if (!text) return;

  const data = {
    type: "msg",
    id: crypto.randomUUID(),
    from: email,
    text,
    time: Date.now()
  };

  ws.send(JSON.stringify(data));
  messages.push({ ...data, mine: true });
  save();
  render({ ...data, mine: true });
  msg.value = "";
}

/* ---------- Typing ---------- */
function sendTyping() {
  ws.send(JSON.stringify({ type: "typing", from: email }));
}

/* ---------- Read Receipt ---------- */
function sendRead(id) {
  ws.send(JSON.stringify({ type: "read", id }));
}

/* ---------- Reactions ---------- */
function react(id, emoji) {
  ws.send(JSON.stringify({ type: "reaction", id, emoji }));
}

/* ---------- Render Message ---------- */
function render(m) {
  const div = document.createElement("div");
  div.className = "bubble " + (m.mine ? "blue" : "gray");
  div.innerHTML = `
    ${m.text || ""}
    <div style="font-size:11px;opacity:.6;text-align:right;">
      ${new Date(m.time).toLocaleTimeString()}
    </div>
    <div style="margin-top:4px;">
      <span onclick="react('${m.id}','‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span onclick="react('${m.id}','üëç')">üëç</span>
      <span onclick="react('${m.id}','üòÇ')">üòÇ</span>
    </div>
  `;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ---------- Redraw ---------- */
function redraw() {
  messagesEl.innerHTML = "";
  messages.forEach(render);
}

/* ---------- Search ---------- */
function searchMessages() {
  const q = search.value.toLowerCase();
  messagesEl.innerHTML = "";
  messages
    .filter(m => (m.text || "").toLowerCase().includes(q))
    .forEach(render);
}

/* ---------- Media ---------- */
function sendMedia() {
  const file = mediaInput.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    const data = {
      type: "msg",
      id: crypto.randomUUID(),
      from: email,
      text: file.type.startsWith("image")
        ? `<img src="${reader.result}" style="max-width:200px;border-radius:12px">`
        : `<video src="${reader.result}" controls style="max-width:200px;border-radius:12px"></video>`,
      time: Date.now()
    };
    ws.send(JSON.stringify(data));
    messages.push({ ...data, mine: true });
    save();
    render({ ...data, mine: true });
  };
  reader.readAsDataURL(file);
}

/* ---------- Voice Input UI ---------- */
if ("webkitSpeechRecognition" in window) {
  const mic = document.createElement("button");
  mic.textContent = "üé§";
  mic.className = "button";
  mic.onclick = () => {
    const r = new webkitSpeechRecognition();
    r.onresult = e => msg.value = e.results[0][0].transcript;
    r.start();
  };
  document.querySelector(".glass").appendChild(mic);
}

/* ---------- Storage ---------- */
function save() {
  localStorage.messages = JSON.stringify(messages);
}
</script>

<script src="/script.js"></script>
</body>
</html>
