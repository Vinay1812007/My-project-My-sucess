<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatgram</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="icon" href="/favicon.png" />
  </head>

  <body>
    <div class="app">
      <header>
        <h1>ðŸ’¬ Chatgram</h1>
        <a href="/" class="button">Home</a>
      </header>

      <section class="glass" id="chatBox" style="flex: 1; overflow-y: auto;">
      </section>

      <section class="glass">
        <form id="chatForm" style="display: flex; gap: 10px;">
          <input
            id="messageInput"
            type="text"
            placeholder="Type a messageâ€¦"
            autocomplete="off"
            style="flex: 1; padding: 12px; border-radius: 12px; border: none;"
          />
          <button class="button" type="submit">Send</button>
        </form>
      </section>
    </div>

    <script type="module">
      import { uid, load, save } from "/script.js";

      const box = document.getElementById("chatBox");
      const form = document.getElementById("chatForm");
      const input = document.getElementById("messageInput");

      const userId = load("chat_user") || uid();
      save("chat_user", userId);

      const ws = new WebSocket(
        location.origin.replace("https", "wss") + "/ws"
      );

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        render(msg.text, msg.user === userId);
      };

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!input.value.trim()) return;
        const payload = { user: userId, text: input.value };
        ws.send(JSON.stringify(payload));
        render(input.value, true);
        input.value = "";
      });

      function render(text, self) {
        const div = document.createElement("div");
        div.className = "glass";
        div.style.marginBottom = "10px";
        div.style.alignSelf = self ? "flex-end" : "flex-start";
        div.style.maxWidth = "80%";
        div.textContent = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }
    </script>
  </body>
</html>
