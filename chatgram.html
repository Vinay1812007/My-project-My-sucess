<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChatGram â€¢ Sirimilla Vinay</title>

  <!-- SEO -->
  <meta name="description" content="ChatGram â€” a modern messenger with iMessage-style UI, reactions, voice notes, and local encryption simulation." />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://sirimillavinay.online/chat" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.png" />
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
<main role="main" aria-label="ChatGram" style="padding-bottom:140px">

  <!-- HEADER -->
  <header class="glass" style="margin:16px; padding:18px; display:flex; justify-content:space-between; align-items:center">
    <div>
      <h1 style="margin:0">ðŸ’¬ ChatGram</h1>
      <div class="muted" id="status">Online</div>
    </div>
    <input
      id="search"
      type="search"
      placeholder="Search messages"
      aria-label="Search messages"
      style="padding:10px; border-radius:12px; border:none"
    />
  </header>

  <!-- CHAT -->
  <section id="chat"
    style="
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    "
    aria-live="polite"
  ></section>

</main>

<!-- INPUT BAR -->
<footer class="glass"
  style="
    position:fixed;
    bottom:70px;
    left:16px;
    right:16px;
    padding:12px;
    display:flex;
    gap:8px;
    align-items:center;
  "
>
  <input type="file" id="image" accept="image/*" hidden />
  <button id="imgBtn" class="button" aria-label="Send image">ðŸ“·</button>
  <button id="micBtn" class="button" aria-label="Record voice">ðŸŽ¤</button>

  <textarea
    id="input"
    rows="1"
    placeholder="Messageâ€¦"
    aria-label="Message"
    style="flex:1; resize:none; padding:10px; border-radius:12px; border:none"
  ></textarea>

  <button id="send" class="button">Send</button>
</footer>

<!-- NAV -->
<nav class="navbar">
  <a href="/home">Home</a>
  <a href="/music">Music</a>
  <a href="/chat.ai">AI</a>
  <a href="/videodownloder">Video</a>
  <a href="/chat" class="active">Chat</a>
</nav>

<script src="/script.js" defer></script>

<script>
(() => {
  "use strict";

  /* -------------------------
     INDEXEDDB
  ------------------------- */
  const DB_NAME = "chatgram-db";
  const STORE = "messages";
  let db;

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        req.result.createObjectStore(STORE, { keyPath: "id" });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function saveMessage(msg) {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put(msg);
  }

  async function getMessages() {
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).getAll();
    return new Promise(res => {
      req.onsuccess = () => res(req.result || []);
    });
  }

  /* -------------------------
     STATE
  ------------------------- */
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const imgBtn = document.getElementById("imgBtn");
  const imageInput = document.getElementById("image");
  const micBtn = document.getElementById("micBtn");
  const search = document.getElementById("search");
  const statusEl = document.getElementById("status");

  let recorder;
  let chunks = [];

  /* -------------------------
     UTIL
  ------------------------- */
  function uuid() {
    return crypto.randomUUID();
  }

  function encryptSim(text) {
    return btoa(unescape(encodeURIComponent(text)));
  }

  function decryptSim(text) {
    try {
      return decodeURIComponent(escape(atob(text)));
    } catch {
      return text;
    }
  }

  function bubble(msg) {
    const el = document.createElement("div");
    el.className = "glass";
    el.style.maxWidth = "80%";
    el.style.padding = "12px";
    el.style.alignSelf = msg.me ? "flex-end" : "flex-start";
    el.style.background = msg.me ? "rgba(76,159,254,0.9)" : "var(--glass)";
    el.style.color = msg.me ? "#fff" : "inherit";
    el.dataset.id = msg.id;

    if (msg.type === "text") {
      el.textContent = decryptSim(msg.content);
    }

    if (msg.type === "image") {
      const img = document.createElement("img");
      img.src = msg.content;
      img.style.maxWidth = "200px";
      img.style.borderRadius = "12px";
      el.appendChild(img);
    }

    if (msg.type === "audio") {
      const audio = document.createElement("audio");
      audio.src = msg.content;
      audio.controls = true;
      el.appendChild(audio);
    }

    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
  }

  /* -------------------------
     SEND TEXT
  ------------------------- */
  async function sendText() {
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    const msg = {
      id: uuid(),
      type: "text",
      content: encryptSim(text),
      me: true,
      ts: Date.now(),
      read: true
    };

    bubble(msg);
    await saveMessage(msg);
  }

  /* -------------------------
     IMAGE
  ------------------------- */
  imgBtn.onclick = () => imageInput.click();
  imageInput.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      const msg = {
        id: uuid(),
        type: "image",
        content: reader.result,
        me: true,
        ts: Date.now()
      };
      bubble(msg);
      await saveMessage(msg);
    };
    reader.readAsDataURL(file);
  };

  /* -------------------------
     VOICE
  ------------------------- */
  micBtn.onclick = async () => {
    if (!recorder) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        chunks = [];
        const url = URL.createObjectURL(blob);
        const msg = {
          id: uuid(),
          type: "audio",
          content: url,
          me: true,
          ts: Date.now()
        };
        bubble(msg);
        await saveMessage(msg);
      };
    }

    if (recorder.state === "inactive") {
      recorder.start();
      micBtn.textContent = "â¹";
    } else {
      recorder.stop();
      micBtn.textContent = "ðŸŽ¤";
    }
  };

  /* -------------------------
     SEARCH
  ------------------------- */
  search.oninput = async e => {
    const q = e.target.value.toLowerCase();
    chat.innerHTML = "";
    const msgs = await getMessages();
    msgs
      .filter(m => decryptSim(m.content || "").toLowerCase().includes(q))
      .forEach(bubble);
  };

  /* -------------------------
     NETWORK STATUS
  ------------------------- */
  function updateStatus() {
    statusEl.textContent = navigator.onLine ? "Online" : "Offline";
  }
  window.addEventListener("online", updateStatus);
  window.addEventListener("offline", updateStatus);
  updateStatus();

  /* -------------------------
     INIT
  ------------------------- */
  document.addEventListener("DOMContentLoaded", async () => {
    db = await openDB();
    const msgs = await getMessages();
    msgs.sort((a, b) => a.ts - b.ts).forEach(bubble);
  });

  sendBtn.onclick = sendText;
  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendText();
    }
  });

})();
</script>

</body>
</html>
