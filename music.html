<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style.css">
</head>

<body>

<div class="header">Music</div>

<div class="safe-bottom" style="padding:16px">

  <!-- Search -->
  <input id="search" placeholder="Search songs, artists…" oninput="searchMusic()">

  <!-- Results -->
  <div id="results" style="margin-top:16px"></div>

</div>

<!-- Player -->
<div id="player" class="glass" style="
  position:fixed;
  bottom:70px;
  left:10px;
  right:10px;
  padding:12px;
  display:none;
  align-items:center;
  gap:12px;
">
  <img id="cover" width="52" height="52" style="border-radius:10px">
  <div style="flex:1">
    <div id="title" style="font-size:14px;font-weight:500"></div>
    <div id="artist" style="font-size:12px;opacity:.6"></div>
    <canvas id="wave" height="24"></canvas>
  </div>
  <button class="button" onclick="toggle()">⏯</button>
  <button class="button" onclick="fav()">❤️</button>
</div>

<!-- Tabs -->
<div class="tab-bar">
  <div class="tab-item" onclick="go('index.html')">Home</div>
  <div class="tab-item" onclick="go('chatgram.html')">Chat</div>
  <div class="tab-item active">Music</div>
  <div class="tab-item" onclick="go('ai.html')">AI</div>
</div>

<script src="/assets/wave.js"></script>
<script>
/* ===============================
   MUSIC APP CORE
   =============================== */

const audio = new Audio();
let current = null;

const favs = JSON.parse(localStorage.favs || "[]");
const recent = JSON.parse(localStorage.recent || "[]");

async function searchMusic() {
  const q = search.value.trim();
  if (!q) return;
  const res = await fetch(
    `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&media=music&limit=20`
  );
  const json = await res.json();
  render(json.results);
}

function render(list) {
  results.innerHTML = "";
  list.forEach(track => {
    const div = document.createElement("div");
    div.className = "glass";
    div.style.padding = "12px";
    div.style.marginBottom = "12px";
    div.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${track.artworkUrl100}" width="60" height="60" style="border-radius:10px">
        <div style="flex:1">
          <div style="font-size:14px">${track.trackName}</div>
          <div style="font-size:12px;opacity:.6">${track.artistName}</div>
        </div>
        <button class="button">▶</button>
      </div>
    `;
    div.onclick = () => play(track);
    results.appendChild(div);
  });
}

function play(track) {
  current = track;
  audio.src = track.previewUrl;
  audio.play();

  title.textContent = track.trackName;
  artist.textContent = track.artistName;
  cover.src = track.artworkUrl100;
  player.style.display = "flex";

  recent.unshift(track);
  localStorage.recent = JSON.stringify(recent.slice(0, 10));

  startWave(audio, document.getElementById("wave"));
}

function toggle() {
  audio.paused ? audio.play() : audio.pause();
}

function fav() {
  if (!favs.find(f => f.trackId === current.trackId)) {
    favs.push(current);
    localStorage.favs = JSON.stringify(favs);
    alert("Added to Favorites ❤️");
  }
}
</script>

<script src="/script.js"></script>
</body>
</html>
