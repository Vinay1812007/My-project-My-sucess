<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat AI</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="/style.css">
<link rel="manifest" href="/manifest.json">
</head>

<body class="glass">

<header class="header">
  ğŸ¤– Chat AI
  <select id="mode">
    <option value="assistant">Assistant</option>
    <option value="coder">Coder</option>
    <option value="teacher">Teacher</option>
    <option value="friend">Friend</option>
  </select>
</header>

<div id="chat" class="chat"></div>

<div class="typing" id="typing">AI is typingâ€¦</div>

<div class="input-bar">
  <button onclick="voice()">ğŸ¤</button>
  <input id="msg" placeholder="Ask anythingâ€¦" />
  <button onclick="send()">Send</button>
</div>

<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js");

let profile = localStorage.getItem("profile") || prompt("Enter profile name:");
localStorage.setItem("profile", profile);

const chat = document.getElementById("chat");
const typing = document.getElementById("typing");
const input = document.getElementById("msg");
const mode = document.getElementById("mode");

let history = JSON.parse(localStorage.getItem("chat_"+profile) || "[]");
history.forEach(addBubble);

function addBubble(role, text) {
  const d = document.createElement("div");
  d.className = "bubble " + role;
  d.textContent = text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

async function streamText(text) {
  const bubble = document.createElement("div");
  bubble.className = "bubble ai";
  chat.appendChild(bubble);

  for (let w of text.split(" ")) {
    bubble.textContent += w + " ";
    await new Promise(r => setTimeout(r, 40));
    chat.scrollTop = chat.scrollHeight;
  }
}

async function send() {
  const t = input.value.trim();
  if (!t) return;

  addBubble("user", t);
  history.push({role:"user",text:t});
  input.value="";
  typing.style.display="block";

  const res = await fetch("https://api.allorigins.win/raw?url=" +
    encodeURIComponent(
      `https://api.affiliateplus.xyz/api/chatbot?message=${encodeURIComponent(t)}
      &name=Vinay&owner=Vinay&user=${profile}&mode=${mode.value}`
    )
  );

  const data = await res.json();
  typing.style.display="none";

  await streamText(data.message);
  history.push({role:"ai",text:data.message});
  localStorage.setItem("chat_"+profile, JSON.stringify(history));
}

function voice() {
  const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  rec.lang = "en-US";
  rec.start();
  rec.onresult = e => input.value = e.results[0][0].transcript;
}
</script>

<script src="/script.js"></script>
</body>
</html>
